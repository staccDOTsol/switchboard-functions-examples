name: "Setup workspace"

description: "Build the workspace and install all dependencies including Rust, NodeJS, and pnpm"

inputs:
  rustVersion:
    description: ""
    required: false
    default: "stable"
  nodeVersion:
    description: "the NodeJS version to install"
    required: false
    default: "18"
  pnpmVersion:
    description: "the pnpm version to install"
    required: false
    default: "8.6.0"
  solcVersion:
    description: "the solidity compiler version"
    required: false
    default: "0.8.17"
  crates:
    description: "Comma-separated list of global binaries to install into Cargo."
    required: false
    default: ""
  skipSolidity:
    description: "Skip installing the Solidity compiler"
    required: false
    default: false

runs:
  using: "composite"
  steps:
  # Install Linux Compilers
  - name: Install Linux Deps
    shell: bash
    run: sudo apt-get update && sudo apt-get install -y pkg-config build-essential libudev-dev

  - name: Setup Rust
    uses: moonrepo/setup-rust@v1
    with:
      inherit-toolchain: true
      components: rustfmt, clippy
      bins: ${{ inputs.crates }}

  - name: Use Node.js
    uses: actions/setup-node@v3
    with:
      node-version: ${{inputs.nodeVersion }}

  - name: Install pnpm
    uses: pnpm/action-setup@v2
    with:
      version: ${{inputs.pnpmVersion }}
      run_install: false

  - name: Get pnpm store directory
    shell: bash
    run: |
      echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

  - uses: actions/cache@v3
    name: Setup pnpm cache
    with:
      path: ${{ env.STORE_PATH }}
      key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
      restore-keys: |
        ${{ runner.os }}-pnpm-store-

  - name: Set up GitHub Actions caching for Turborepo
    uses: dtinth/setup-github-actions-caching-for-turbo@v1.1.0

  - name: Install Dependencies
    shell: bash
    run: pnpm install --no-frozen-lockfile

  - name: Install Global NPM Deps
    shell: bash
    run: pnpm add -g turbo
